### 事务

**事务的基本操作**

+ 开启事务

```
multi #设定事务的开启位置，此指令执行后，后续的所有指令均加入到事务中
```

+ 执行事务

```
exec #设定事务的结束位置，同时执行事务。与multi成对出现，成对使用，注意：加入事务的命令暂时进入到任务队列中，并没有立即执行，只有执行exec命令才开始执行
```

+ 取消事务

```
discard #终止当前事务的定义，发生在multi之后，exec之前
```

![image-20200820214157335](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820214157335.png)

**事务的工作流程**

![image-20200820214410017](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820214410017.png)

**事务的注意事项**

+ 如果定义的事务中所包含的命令存在语法错误，整体事务中所有命令均不会执行。包括那些语法正确的命令。
+ 指命令格式正确，但是无法正确的执行。例如对string进行lpush操作，已经执行完毕的命令对应的数据不会自动回滚，需要程序员自己在代码中实现回滚。

![image-20200820214555866](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820214555866.png)



### 锁机制

**业务场景**

+ 天猫双11热卖过程中，对已经售罄的货物追加补货，4个业务员都有权限进行补货。补货的操作可能是一系

  列的操作，牵扯到多个连续操作，如何保障不会重复操作？

**业务分析**

+ 多个客户端有可能同时操作同一组数据，并且该数据一旦被操作修改后，将不适用于继续操作，在操作之前锁定要操作的数据，一旦发生变化，终止当前操作

**基于特定条件的事务执行——锁**

+ 对 key 添加监视锁，在执行exec前如果key发生了变化，终止事务执行

  ```
  watch key1 [key2……]
  ```

+ 取消对所有 key 的监视

  ```
  unwatch
  ```

+ redis 应用基于状态控制的批量任务执行

  ![image-20200820220246838](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820220246838.png)

  ![image-20200820215934664](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820215934664.png)

  ![image-20200820220202275](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820220202275.png)

  ![image-20200820220132311](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820220132311.png)

  ![image-20200820215240262](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820215240262.png)

**基于特定条件的事务执行——分布式锁**

+ 解决秒杀超卖现象

  + 使用 setnx 设置一个公共锁 `setnx lock-key value #value随便定义一般写1`

  + 利用setnx命令的返回值特征，有值则返回设置失败，无值则返回设置成功

  + 对于返回设置成功的，拥有控制权，进行下一步的具体业务操作
  + 对于返回设置失败的，不具有控制权，排队或等待,操作完毕通过del操作释放锁
  + 使用 expire 为锁key添加时间限定，到时不释放，放弃锁

  ![image-20200820220948023](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200820220948023.png)

