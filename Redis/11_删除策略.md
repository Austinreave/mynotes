**数据删除策略**

+ 定时删除

  + 创建一个定时器，当key设置有过期时间，且过期时间到达时，由定时器任务立即执行对键的删除操作

  + 优点：节约内存，到时就删除，快速释放掉不必要的内存占用

  + 缺点：CPU压力很大，无论CPU此时负载量多高，均占用CPU，会影响redis服务器响应时间和指令吞吐量

  + 总结：用处理器性能换取存储空间（拿时间换空间）

    ![image-20200821214039334](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200821214039334.png)

+ 惰性删除

  + 数据到达过期时间，不做处理。等下次访问该数据时如果未过期，返回数据，发现已过期，删除，返回不存在

  + 优点：节约CPU性能，发现必须删除的时候才删除

  + 缺点：内存压力很大，出现长期占用内存的数据

  + 总结：用存储空间换取处理器性能 （拿时间换空间）

    ![image-20200821214156928](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200821214156928.png)

+ 定期删除

  + Redis启动服务器初始化时，读取配置server.hz的值，默认为10，
+ ![image-20200821215508143](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200821215508143.png)
  
  + activeExpireCycle()对每个expires[*]逐一进行检测，每次执行250ms/server.hz
+ ![image-20200821214509337](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200821214509337.png)
  + 周期性轮询redis库中的时效性数据，采用随机抽取的策略，利用过期数据占比的方式控制删除频度

    + 特点1：CPU性能占用设置有峰值，检测频度可自定义设置
  + 特点2：内存压力不是很大，长期占用内存的冷数据会被持续清理
    + 总结：周期性抽查存储空间（随机抽查，重点抽查）
  

**删除策略比对**

![image-20200821214759343](C:\Users\星星\AppData\Roaming\Typora\typora-user-images\image-20200821214759343.png)

**当新数据进入redis时，如果内存不足怎么办**

+ Redis使用内存存储数据，在执行每一个命令前，会调用**freeMemoryIfNeeded()**检测内存是否充足。如

  果内存不满足新加入数据的最低存储要求，redis要临时删除一些数据为当前指令清理存储空间。清理数据

  的策略称为逐出算法。

+ 影响数据逐出的相关配置

  + ```
    #最大可使用内存
    maxmemory #占用物理内存的比例，默认值为0，表示不限制。生产环境中根据需求设定，通常设置在50%以上。
    #每次选取待删除数据的个数
    maxmemory-samples #选取数据时并不会全库扫描，导致严重的性能消耗，降低读写性能。因此采用随机获取数据的方式作为待检测删除数据
    #删除策略
    maxmemory-policy #达到最大内存后的，对被挑选出来的数据进行删除的策略
    ```

+  检测易失数据（可能会过期的数据集server.db[i].expires ） 
  1. volatile-lru：挑选最近最少使用的数据淘汰
  2.  volatile-lfu：挑选最近使用次数最少的数据淘汰
  3. volatile-ttl：挑选将要过期的数据淘汰
  4. volatile-random：任意选择数据淘汰